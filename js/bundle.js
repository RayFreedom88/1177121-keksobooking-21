(()=>{"use strict";(()=>{const e=document.querySelector(".map").offsetWidth;let t=document.querySelector(".map"),n=document.querySelector(".map__pin--main"),o=t.querySelector(".map__filters-container"),r=document.querySelectorAll(".map__filter"),i=document.querySelector(".ad-form"),u=i.querySelectorAll("fieldset"),c=i.querySelector("#address"),d=[],a=function(e){let t=document.createDocumentFragment(),n=window.pin.mapPinsElement;e.forEach((function(e){t.appendChild(window.pin.getPin(e))})),n.appendChild(t)},l=function(e){for(let t=0;t<e.length;t++)e[t].disabled=!0};l(u),l(r);let s=function(e){for(let t=0;t<e.length;t++)e[t].disabled=!1},p=function(e,t){c.value=e+","+t};p(570,375);let m=function(e){d=e.slice().filter((function(e){return 0!==Object.keys(e.offer).length})),a(d.slice(0,5)),n.removeEventListener("mousedown",v),n.removeEventListener("keydown",y)},f=function(e){window.message.onErrorSend(e)},w=function(){s(u),s(r),t.classList.remove("map--faded"),i.classList.remove("ad-form--disabled"),window.backend.load(m,f)},v=function(e){e.button===window.util.key.LEFT_MOUSE&&w()},y=function(e){window.util.isEnterEvent(e,(function(){w()}))};n.addEventListener("mousedown",w),n.addEventListener("keydown",y),window.main={MAX_COUNT:5,MAX_LOCATION_X:e,MIN_LOCATION_X:0,MIN_LOCATION_Y:130,MAX_LOCATION_Y:630,MIN_WIDTH_PINS:50,MIN_HEIGHT_PINS:70,mapElement:t,mapPinMainElement:n,mapFiltersContainer:o,adFormElement:i,pinAddressInputElement:c,offers:function(){return d},getDeactivePage:function(){t.classList.add("map--faded"),i.reset(),i.classList.add("ad-form--disabled"),l(u),l(r),p(570,375),n.style.left="570px",n.style.top="375px",window.card.removePopup(),window.pin.removePins(),window.preview.resetPreview(),n.addEventListener("mousedown",w),n.addEventListener("keydown",w)},createPins:a}})(),(()=>{let e={LEFT_MOUSE:0,ENTER:13,ESC:27};window.util={key:e,isEnterEvent:function(t,n){t.keyCode===e.ENTER&&n()},isEscEvent:function(t,n){t.keyCode===e.ESC&&(t.preventDefault(),n())}}})(),window.debounce=function(e){let t=null;return function(...n){t&&window.clearTimeout(t),t=window.setTimeout((function(){e(...n)}),500)}},(()=>{let e=document.querySelector("main"),t=function(){document.querySelector(".error").remove(),document.removeEventListener("keydown",r),document.removeEventListener("mousedown",o)},n=function(){t()},o=function(){t()},r=function(e){window.util.isEscEvent(e,t)},i=function(){document.querySelector(".success").remove(),document.removeEventListener("keydown",c),document.removeEventListener("mousedown",u)},u=function(){i()},c=function(e){window.util.isEscEvent(e,i)};window.message={onErrorSend:function(t){let i=document.querySelector("#error").content.querySelector(".error").cloneNode(!0);i.querySelector(".error__message").textContent=t,i.querySelector(".error__button").addEventListener("click",n),e.appendChild(i),document.addEventListener("keydown",r),document.addEventListener("mousedown",o)},onSuccessSend:function(){let t=document.querySelector("#success").content.querySelector(".success").cloneNode(!0);e.appendChild(t),document.addEventListener("keydown",c),document.addEventListener("mousedown",u)}}})(),(()=>{let e=function(e,t,n){let o=new XMLHttpRequest;o.responseType="json",o.timeout=1e4,o.addEventListener("load",(function(){200===o.status?e(o.response):t("Cтатус ответа: "+o.status+" "+o.statusText)})),o.addEventListener("error",(function(){t("Произошла ошибка соединения")})),o.addEventListener("timeout",(function(){t("Запрос не успел выполниться за "+o.timeout+"мс")})),n?(o.open("POST","https://21.javascript.pages.academy/keksobooking"),o.send(n)):(o.open("GET","https://21.javascript.pages.academy/keksobooking/data"),o.send())};window.backend={load:e,save:e}})(),(()=>{let e=window.main.mapElement,t=window.main.MIN_WIDTH_PINS,n=window.main.MIN_HEIGHT_PINS,o=e.querySelector(".map__pins"),r=window.main.mapFiltersContainer,i=function(){let t=e.querySelector(".map__pin--active");null!==t&&t.classList.remove("map__pin--active")};window.pin={mapPinsElement:o,getPin:function(u){let c=document.querySelector("#pin").content.querySelector(".map__pin").cloneNode(!0);c.querySelector("img").src=u.author.avatar,c.querySelector("img").alt=u.offer.description;let d=u.location.x-t/2+"px",a=u.location.y-n+"px";return c.style.left=d,c.style.top=a,o.appendChild(c),c.addEventListener("click",(function(){i(),c.classList.add("map__pin--active"),window.card.removePopup(),e.insertBefore(window.card.getCard(u),r)})),c},removePins:function(){let t=e.querySelectorAll(".map__pin:not(.map__pin--main)");t.length>0&&t.forEach((function(e){e.remove()}))},removeActivePin:i}})(),(()=>{let e=window.main.mapElement,t=window.util.isEscEvent,n=function(r){let i=e.querySelector(".popup");t(r,(function(){null!==i&&(o(),document.removeEventListener("keydown",n),window.pin.removeActivePin())}))},o=function(){let t=e.querySelector(".popup");null!==t&&t.remove()};window.card={getCard:function(e){let t=document.querySelector("#card").content.querySelector(".map__card").cloneNode(!0);t.querySelector(".popup__avatar").src=e.author.avatar,t.querySelector(".popup__avatar").alt=e.offer.description,t.querySelector(".popup__title").textContent=e.offer.title,t.querySelector(".popup__text--address").textContent=e.offer.address,t.querySelector(".popup__text--price").textContent=e.offer.price+"₽/ночь",t.querySelector(".popup__type").textContent=e.offer.type,t.querySelector(".popup__text--capacity").textContent=`${e.offer.rooms} ${1===e.offer.rooms?"комната":"комнаты"} для ${e.offer.guests} ${1===e.offer.guests?"гостя":"гостей"}`,t.querySelector(".popup__text--time").textContent=`Заезд после ${e.offer.checkin}, выезд до ${e.offer.checkout}`;let r=t.querySelectorAll(".popup__feature");for(let t of r)e.offer.features.indexOf(t.classList[1].replace("popup__feature--",""))<0&&t.remove();t.querySelector(".popup__description").textContent=e.offer.description;let i=t.querySelector(".popup__photos"),u=i.querySelector(".popup__photo");if(e.offer.photos.length>0){u.remove();for(let t of e.offer.photos){let e=document.querySelector("#card").content.querySelector(".popup__photo").cloneNode(!0);e.src=t,i.appendChild(e)}}else i.remove();let c=t.querySelector(".popup__close");return document.addEventListener("keydown",n),c.addEventListener("click",(function(){o(),window.pin.removeActivePin(),document.removeEventListener("keydown",n)})),t},removePopup:o}})(),(()=>{let e=window.main.adFormElement,t=e.querySelector("#type"),n=e.querySelector("#price"),o=e.querySelector("#room_number"),r=e.querySelector("#capacity"),i=e.querySelector("#timein"),u=e.querySelector("#timeout"),c=e.querySelector(".ad-form__reset"),d={palace:{ru:"Дворец",min:"10000"},flat:{ru:"Квартира",min:"1000"},house:{ru:"Дом",min:"5000"},bungalow:{ru:"Бунгало",min:"0"}},a={1:[1],2:[1,2],3:[1,2,3],100:[0]};window.main.pinAddressInputElement.readOnly=!0,t.addEventListener("change",(function(){n.min=d[t.value].min,n.placeholder=d[t.value].min})),o.addEventListener("change",(function(){!function(e){let t=r.querySelectorAll("option");for(let e=0;e<t.length;e++)t[e].disabled=!0;a[e].forEach((function(e){r.querySelector(`[value="${e}"]`).disabled=!1,r.value=e}))}(o.value)})),i.addEventListener("change",(function(){u.value=i.value})),u.addEventListener("change",(function(){i.value=u.value}));let l=function(){window.message.onErrorSend("Ошибка загрузки объявления")},s=function(){window.message.onSuccessSend(),window.main.getDeactivePage()};e.addEventListener("submit",(function(t){t.preventDefault(),window.backend.save(s,l,new FormData(e))})),c.addEventListener("click",(function(e){e.preventDefault(),window.main.getDeactivePage()}))})(),(()=>{let e=window.main.mapFiltersContainer.querySelector("form"),t={low:{start:0,end:1e4},middle:{start:1e4,end:5e4},high:{start:5e4,end:1/0}},n=Array.from(e.children),o={"housing-type":function(e,t){return t.value===e.offer.type},"housing-price":function(e,n){return e.offer.price>=t[n.value].start&&e.offer.price<t[n.value].end},"housing-rooms":function(e,t){return t.value===e.offer.rooms.toString()},"housing-guests":function(e,t){return t.value===e.offer.guests.toString()},"housing-features":function(e,t){return Array.from(t.querySelectorAll("input[type=checkbox]:checked")).every((function(t){return e.offer.features.some((function(e){return e===t.value}))}))}},r=function(e){return e.filter((function(e){return n.every((function(t){return"any"===t.value||o[t.id](e,t)}))}))},i=window.debounce((function(){window.card.removePopup(),window.pin.removePins(),window.main.createPins(r(window.main.offers()).slice(0,window.main.MAX_COUNT))}));e.addEventListener("change",i),window.filter=r})(),(()=>{const e=["gif","jpg","jpeg","png"];let t=70,n=70,o="Фотография жилья",r=window.main.adFormElement,i=r.querySelector(".ad-form-header__upload input[type=file]"),u=r.querySelector(".ad-form-header__upload img"),c=u.src,d=r.querySelector(".ad-form__photo-container"),a=r.querySelector(".ad-form__upload input[type=file]"),l=r.querySelector(".ad-form__photo"),s=[],p=function(t,n){let o=t.files[0],r=o.name.toLowerCase();if(e.some((function(e){return r.endsWith(e)}))){let e=new FileReader;e.addEventListener("load",(function(){n(e.result)})),e.readAsDataURL(o)}};i.addEventListener("change",(function(){p(i,(function(e){u.src=e}))})),a.addEventListener("change",(function(){p(a,m)}));let m=function(e){let r=document.createElement("div");r.classList.add("ad-form__photo");let i=document.createElement("img");i.src=e,i.width=t,i.height=n,i.alt=o,r.appendChild(i),s.push(r),d.insertBefore(r,l)};window.preview={resetPreview:function(){s&&s.forEach((function(e){e.remove()})),s=[],u.src=c}}})(),(()=>{let e=window.main.mapPinMainElement,t=e.clientWidth,n=e.clientHeight,o=window.main.MIN_LOCATION_X,r=window.main.MIN_LOCATION_Y,i=window.main.MAX_LOCATION_Y,u=window.main.MAX_LOCATION_X;e.addEventListener("mousedown",(function(c){if(c.button===window.util.key.LEFT_MOUSE){c.preventDefault();let d={x:c.clientX,y:c.clientY},a=function(c){c.preventDefault();let a={x:d.x-c.clientX,y:d.y-c.clientY};d={x:c.clientX,y:c.clientY},function(c){let d=e.offsetTop-c.y,a=e.offsetLeft-c.x;a>u-t/2?a=u-t/2:a<o-t/2&&(a=o-t/2),d>i-n?d=i-n:d<r-n&&(d=r-n),e.style.top=d+"px",e.style.left=a+"px",window.main.pinAddressInputElement.value=Math.round(parseInt(e.style.left,10)+t/2)+", "+Math.round(parseInt(e.style.top,10)+n/2)}(a)},l=function(e){e.preventDefault(),document.removeEventListener("mousemove",a),document.removeEventListener("mouseup",l)};document.addEventListener("mousemove",a),document.addEventListener("mouseup",l)}}))})()})();