(()=>{"use strict";(()=>{const e=document.querySelector(".map"),t=e.querySelector(".map__pin--main");window.mainElement={map:e,pin:t}})(),(()=>{const e={COORDS_X:570,COORDS_Y:375,GUESTS_COUNT:1,MAX_COUNT:5,MIN_WIDTH_PINS:50,MIN_HEIGHT_PINS:70,MIN_LOCATION_X:0,MAX_LOCATION_X:document.querySelector(".map").offsetWidth,MIN_LOCATION_Y:130,MAX_LOCATION_Y:630,NUMBER_GUEST:{1:[1],2:[1,2],3:[1,2,3],100:[0]},TYPES:{palace:{ru:"Дворец",min:"10000"},flat:{ru:"Квартира",min:"1000"},house:{ru:"Дом",min:"5000"},bungalow:{ru:"Бунгало ",min:"0"}}};window.constants=e})(),(()=>{const e={LEFT_MOUSE:0,ENTER:13,ESC:27};window.util={key:e,onEnterEvent:function(t,n){t.keyCode===e.ENTER&&n()},onEscEvent:function(t,n){t.keyCode===e.ESC&&(t.preventDefault(),n())}}})(),window.debounce=function(e){let t=null;return function(...n){t&&window.clearTimeout(t),t=window.setTimeout((function(){e(...n)}),500)}},(()=>{let e=!1;const t=document.querySelector("main"),n=document.querySelector("#error").content.querySelector(".error"),o=document.querySelector("#success").content.querySelector(".success"),r=function(){s()},i=function(){s()},c=function(e){window.util.onEscEvent(e,s)},d=function(){document.addEventListener("keydown",c),document.addEventListener("mousedown",i)},s=function(){const t=e?".error":".success";document.querySelector(t).remove(),document.removeEventListener("keydown",c),document.removeEventListener("mousedown",i)};window.message={onErrorSend:function(o){e=!0;const i=n.cloneNode(!0);i.querySelector(".error__message").textContent=o,i.querySelector(".error__button").addEventListener("click",r),t.appendChild(i),d()},onSuccessSend:function(){e=!1;const n=o.cloneNode(!0);t.appendChild(n),d()}}})(),(()=>{const e=function(e,t,n){let o=new XMLHttpRequest;o.responseType="json",o.timeout=1e4,o.addEventListener("load",(()=>{200===o.status?e(o.response):t("Cтатус ответа: "+o.status+" "+o.statusText)})),o.addEventListener("error",(function(){t("Произошла ошибка соединения")})),o.addEventListener("timeout",(()=>{t("Запрос не успел выполниться за "+o.timeout+"мс")})),n?(o.open("POST","https://21.javascript.pages.academy/keksobooking"),o.send(n)):(o.open("GET","https://21.javascript.pages.academy/keksobooking/data"),o.send())};window.backend={load:e,save:e}})(),(()=>{const e=window.mainElement.map.querySelector(".map__filters-container"),t=e.querySelector("form"),n={low:{start:0,end:1e4},middle:{start:1e4,end:5e4},high:{start:5e4,end:1/0}},o=Array.from(t.children),r={"housing-type":function(e,t){return t.value===e.offer.type},"housing-price":function(e,t){return e.offer.price>=n[t.value].start&&e.offer.price<n[t.value].end},"housing-rooms":function(e,t){return t.value===e.offer.rooms.toString()},"housing-guests":function(e,t){return t.value===e.offer.guests.toString()},"housing-features":function(e,t){return Array.from(t.querySelectorAll("input[type=checkbox]:checked")).every((function(t){return e.offer.features.some((function(e){return e===t.value}))}))}},i=function(e){return e.filter((function(e){return o.every((function(t){return"any"===t.value||r[t.id](e,t)}))}))},c=window.debounce((function(){window.card.remove(),window.pin.remove(),window.pin.render(i(window.main.offers()).slice(0,window.constants.MAX_COUNT))}));t.addEventListener("change",c),window.filter={element:{container:e,form:t},filterData:i}})(),(()=>{const e=window.constants.TYPES,t=document.querySelector(".ad-form"),n=t.querySelectorAll("fieldset"),o=t.querySelector("#address"),r=t.querySelector("#type"),i=t.querySelector("#price"),c=t.querySelector("#room_number"),d=t.querySelector("#capacity"),s=t.querySelector("#timein"),u=t.querySelector("#timeout"),a=t.querySelector(".ad-form__reset"),l=window.constants.NUMBER_GUEST,f=window.filter.element.form.querySelectorAll(".map__filter");o.readOnly=!0;const p=function(e){for(let t=0;t<e.length;t++)e[t].disabled=!0},m=function(e){for(let t=0;t<e.length;t++)e[t].disabled=!1},w=function(){i.min=e[r.value].min,i.placeholder=e[r.value].min};r.addEventListener("change",w),c.addEventListener("change",(function(){!function(e){const t=d.querySelectorAll("option");for(let e=0;e<t.length;e++)t[e].disabled=!0;l[e].forEach((function(e){d.querySelector(`[value="${e}"]`).disabled=!1,d.value=e}))}(c.value)})),s.addEventListener("change",(function(){u.value=s.value})),u.addEventListener("change",(function(){s.value=u.value}));const v=function(){window.message.onErrorSend("Ошибка загрузки объявления")},_=function(){window.message.onSuccessSend(),window.main.deactivatePage()};t.addEventListener("submit",(function(e){e.preventDefault(),window.backend.save(_,v,new FormData(t))})),a.addEventListener("click",(function(e){e.preventDefault(),window.main.deactivatePage()})),window.form={element:{ad:t,pinAddressInput:o},setAddressCoords:function(e,t){o.value=e+","+t},setDisabled:function(){p(n),p(f)},setActive:function(){m(n),m(f)},onTypeSelectChange:w}})(),(()=>{const e=window.constants.MIN_WIDTH_PINS,t=window.constants.MIN_HEIGHT_PINS,n=window.mainElement.map,o=n.querySelector(".map__pins"),r=window.filter.element.container,i=document.querySelector("#pin").content,c=function(c){const s=i.querySelector(".map__pin").cloneNode(!0);s.querySelector("img").src=c.author.avatar,s.querySelector("img").alt=c.offer.description;let u=c.location.x-e/2+"px",a=c.location.y-t+"px";return s.style.left=u,s.style.top=a,o.appendChild(s),s.addEventListener("click",(()=>{d(),s.classList.add("map__pin--active"),window.card.remove(),n.insertBefore(window.card.create(c),r)})),s},d=function(){const e=n.querySelector(".map__pin--active");null!==e&&e.classList.remove("map__pin--active")};window.pin={create:c,render:function(e){const t=document.createDocumentFragment();e.forEach((function(e){t.appendChild(c(e))})),o.appendChild(t)},remove:function(){const e=n.querySelectorAll(".map__pin:not(.map__pin--main)");e.length>0&&e.forEach((function(e){e.remove()}))},removeActive:d}})(),(()=>{const e=window.util.onEscEvent,t=window.constants.TYPES,n=window.mainElement.map,o=document.querySelector("#card").content,r=function(t){const o=n.querySelector(".popup");e(t,(()=>{null!==o&&(i(),document.removeEventListener("keydown",r),window.pin.removeActive())}))},i=function(){let e=n.querySelector(".popup");null!==e&&e.remove()};window.card={create:function(e){const n=o.querySelector(".map__card").cloneNode(!0);n.querySelector(".popup__avatar").src=e.author.avatar,n.querySelector(".popup__avatar").alt=e.offer.description,n.querySelector(".popup__title").textContent=e.offer.title,n.querySelector(".popup__text--address").textContent=e.offer.address,n.querySelector(".popup__text--price").textContent=e.offer.price+"₽/ночь",n.querySelector(".popup__type").textContent=t[e.offer.type].ru,n.querySelector(".popup__text--capacity").textContent=`${e.offer.rooms} ${e.offer.rooms===window.constants.GUESTS_COUNT?"комната":"комнаты"} для ${e.offer.guests} ${e.offer.guests===window.constants.GUESTS_COUNT?"гостя":"гостей"}`,n.querySelector(".popup__text--time").textContent=`Заезд после ${e.offer.checkin}, выезд до ${e.offer.checkout}`;const c=n.querySelector(".popup__features"),d=n.querySelectorAll(".popup__feature");for(let t of d)e.offer.features.indexOf(t.classList[1].replace("popup__feature--",""))<0&&t.remove(),0===e.offer.features.length&&c.remove();n.querySelector(".popup__description").textContent=e.offer.description;const s=n.querySelector(".popup__photos"),u=s.querySelector(".popup__photo");if(e.offer.photos.length>0){u.remove();for(let t of e.offer.photos){const e=document.querySelector("#card").content.querySelector(".popup__photo").cloneNode(!0);e.src=t,s.appendChild(e)}}else s.remove();const a=n.querySelector(".popup__close");return document.addEventListener("keydown",r),a.addEventListener("click",(()=>{i(),window.pin.removeActive(),document.removeEventListener("keydown",r)})),n},remove:i}})(),(()=>{const e=["gif","jpg","jpeg","png"],t=70,n=70,o="Фотография жилья",r=window.form.element.ad,i=r.querySelector(".ad-form-header__upload input[type=file]"),c=r.querySelector(".ad-form-header__upload img"),d=c.src,s=r.querySelector(".ad-form__photo-container"),u=r.querySelector(".ad-form__upload input[type=file]"),a=r.querySelector(".ad-form__photo");let l=[];const f=function(t,n){const o=t.files[0],r=o.name.toLowerCase();if(e.some((function(e){return r.endsWith(e)}))){let e=new FileReader;e.addEventListener("load",(()=>{n(e.result)})),e.readAsDataURL(o)}};i.addEventListener("change",(()=>{f(i,(function(e){c.src=e}))})),u.addEventListener("change",(()=>{f(u,p)}));const p=function(e){const r=document.createElement("div");r.classList.add("ad-form__photo");const i=document.createElement("img");i.src=e,i.width=t,i.height=n,i.alt=o,r.appendChild(i),l.push(r),s.insertBefore(r,a)};window.preview={reset:function(){l&&l.forEach((function(e){e.remove()})),l=[],c.src=d}}})(),(()=>{const e=window.mainElement.pin,t=e.clientWidth,n=e.clientHeight,o=window.constants.MIN_LOCATION_X,r=window.constants.MIN_LOCATION_Y,i=window.constants.MAX_LOCATION_Y,c=window.constants.MAX_LOCATION_X;e.addEventListener("mousedown",(function(d){if(d.button===window.util.key.LEFT_MOUSE){d.preventDefault();let s={x:d.clientX,y:d.clientY};const u=function(d){d.preventDefault();let u={x:s.x-d.clientX,y:s.y-d.clientY};s={x:d.clientX,y:d.clientY},function(d){let s=e.offsetTop-d.y,u=e.offsetLeft-d.x;u>c-t/2?u=c-t/2:u<o-t/2&&(u=o-t/2),s>i-n?s=i-n:s<r-n&&(s=r-n),e.style.top=s+"px",e.style.left=u+"px",window.form.element.pinAddressInput.value=Math.round(parseInt(e.style.left,10)+t/2)+", "+Math.round(parseInt(e.style.top,10)+n/2)}(u)},a=function(e){e.preventDefault(),document.removeEventListener("mousemove",u),document.removeEventListener("mouseup",a)};document.addEventListener("mousemove",u),document.addEventListener("mouseup",a)}}))})(),(()=>{const e=window.constants.MAX_COUNT,t=window.constants.COORDS_X,n=window.constants.COORDS_Y,o=window.mainElement.map,r=window.mainElement.pin,i=window.filter.element.form,c=window.form.element.ad;let d=[];window.form.setAddressCoords(t,n),window.form.setDisabled();const s=function(t){d=t.slice().filter((function(e){return 0!==Object.keys(e.offer).length})),window.pin.render(d.slice(0,e)),window.form.setActive(),o.classList.remove("map--faded"),c.classList.remove("ad-form--disabled"),r.removeEventListener("mousedown",l),r.removeEventListener("keydown",f)},u=function(e){window.message.onErrorSend(e)},a=function(){window.backend.load(s,u)},l=function(e){e.button===window.util.key.LEFT_MOUSE&&a()},f=function(e){window.util.onEnterEvent(e,(function(){a()}))};r.addEventListener("mousedown",l),r.addEventListener("keydown",f),window.main={offers:()=>d,deactivatePage:function(){o.classList.add("map--faded"),i.reset(),c.reset(),c.classList.add("ad-form--disabled"),window.form.onTypeSelectChange(),window.form.setDisabled(),window.form.setAddressCoords(t,n),r.style.left=t+"px",r.style.top=n+"px",window.card.remove(),window.pin.remove(),window.preview.reset(),r.addEventListener("mousedown",l),r.addEventListener("keydown",f)}}})()})();