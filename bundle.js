(()=>{"use strict";(()=>{let e={MAX_COUNT:5,MIN_WIDTH_PINS:50,MIN_HEIGHT_PINS:70,MIN_LOCATION_X:0,MAX_LOCATION_X:document.querySelector(".map").offsetWidth,MIN_LOCATION_Y:130,MAX_LOCATION_Y:630,COORDS_X:630,COORDS_Y:375,TYPES:{palace:{ru:"Дворец",min:"10000"},flat:{ru:"Квартира",min:"1000"},house:{ru:"Дом",min:"5000"},bungalow:{ru:"Бунгало ",min:"0"}}};window.constants=e})(),(()=>{let e={LEFT_MOUSE:0,ENTER:13,ESC:27};window.util={key:e,isEnterEvent:function(t,n){t.keyCode===e.ENTER&&n()},isEscEvent:function(t,n){t.keyCode===e.ESC&&(t.preventDefault(),n())}}})(),(()=>{const e=window.constants.MAX_COUNT,t=window.constants.COORDS_X,n=window.constants.COORDS_Y;let o=document.querySelector(".map"),r=document.querySelector(".map__pin--main"),i=o.querySelector(".map__filters-container"),c=document.querySelectorAll(".map__filter"),u=document.querySelector(".ad-form"),d=u.querySelectorAll("fieldset"),a=u.querySelector("#address"),l=[],s=function(e){let t=document.createDocumentFragment(),n=window.pin.mapPinsElement;e.forEach((function(e){t.appendChild(window.pin.getPin(e))})),n.appendChild(t)},p=function(e){for(let t=0;t<e.length;t++)e[t].disabled=!0};p(d),p(c);let f=function(e){for(let t=0;t<e.length;t++)e[t].disabled=!1},m=function(e,t){a.value=e+","+t};m(t,n);let w=function(t){l=t.slice().filter((function(e){return 0!==Object.keys(e.offer).length})),s(l.slice(0,e)),r.removeEventListener("mousedown",_),r.removeEventListener("keydown",E)},v=function(e){window.message.onErrorSend(e)},y=function(){f(d),f(c),o.classList.remove("map--faded"),u.classList.remove("ad-form--disabled"),window.backend.load(w,v)},_=function(e){e.button===window.util.key.LEFT_MOUSE&&y()},E=function(e){window.util.isEnterEvent(e,(function(){y()}))};r.addEventListener("mousedown",_),r.addEventListener("keydown",E),window.main={mapElement:o,mapPinMainElement:r,mapFiltersContainer:i,adFormElement:u,pinAddressInputElement:a,offers:function(){return l},getDeactivePage:function(){o.classList.add("map--faded"),u.reset(),u.classList.add("ad-form--disabled"),p(d),p(c),m(t,n),r.style.left=t+"px",r.style.top=n+"px",window.card.removePopup(),window.pin.removePins(),window.preview.resetPreview(),r.addEventListener("mousedown",y),r.addEventListener("keydown",y)},createPins:s}})(),window.debounce=function(e){let t=null;return function(...n){t&&window.clearTimeout(t),t=window.setTimeout((function(){e(...n)}),500)}},(()=>{let e=document.querySelector("main"),t=function(){document.querySelector(".error").remove(),document.removeEventListener("keydown",r),document.removeEventListener("mousedown",o)},n=function(){t()},o=function(){t()},r=function(e){window.util.isEscEvent(e,t)},i=function(){document.querySelector(".success").remove(),document.removeEventListener("keydown",u),document.removeEventListener("mousedown",c)},c=function(){i()},u=function(e){window.util.isEscEvent(e,i)};window.message={onErrorSend:function(t){let i=document.querySelector("#error").content.querySelector(".error").cloneNode(!0);i.querySelector(".error__message").textContent=t,i.querySelector(".error__button").addEventListener("click",n),e.appendChild(i),document.addEventListener("keydown",r),document.addEventListener("mousedown",o)},onSuccessSend:function(){let t=document.querySelector("#success").content.querySelector(".success").cloneNode(!0);e.appendChild(t),document.addEventListener("keydown",u),document.addEventListener("mousedown",c)}}})(),(()=>{let e=function(e,t,n){let o=new XMLHttpRequest;o.responseType="json",o.timeout=1e4,o.addEventListener("load",(function(){200===o.status?e(o.response):t("Cтатус ответа: "+o.status+" "+o.statusText)})),o.addEventListener("error",(function(){t("Произошла ошибка соединения")})),o.addEventListener("timeout",(function(){t("Запрос не успел выполниться за "+o.timeout+"мс")})),n?(o.open("POST","https://21.javascript.pages.academy/keksobooking"),o.send(n)):(o.open("GET","https://21.javascript.pages.academy/keksobooking/data"),o.send())};window.backend={load:e,save:e}})(),(()=>{const e=window.constants.MIN_WIDTH_PINS,t=window.constants.MIN_HEIGHT_PINS;let n=window.main.mapElement,o=n.querySelector(".map__pins"),r=window.main.mapFiltersContainer,i=function(){let e=n.querySelector(".map__pin--active");null!==e&&e.classList.remove("map__pin--active")};window.pin={mapPinsElement:o,getPin:function(c){let u=document.querySelector("#pin").content.querySelector(".map__pin").cloneNode(!0);u.querySelector("img").src=c.author.avatar,u.querySelector("img").alt=c.offer.description;let d=c.location.x-e/2+"px",a=c.location.y-t+"px";return u.style.left=d,u.style.top=a,o.appendChild(u),u.addEventListener("click",(function(){i(),u.classList.add("map__pin--active"),window.card.removePopup(),n.insertBefore(window.card.getCard(c),r)})),u},removePins:function(){let e=n.querySelectorAll(".map__pin:not(.map__pin--main)");e.length>0&&e.forEach((function(e){e.remove()}))},removeActivePin:i}})(),(()=>{let e=window.util.isEscEvent,t=window.constants.TYPES,n=window.main.mapElement,o=function(t){let i=n.querySelector(".popup");e(t,(function(){null!==i&&(r(),document.removeEventListener("keydown",o),window.pin.removeActivePin())}))},r=function(){let e=n.querySelector(".popup");null!==e&&e.remove()};window.card={getCard:function(e){let n=document.querySelector("#card").content.querySelector(".map__card").cloneNode(!0);n.querySelector(".popup__avatar").src=e.author.avatar,n.querySelector(".popup__avatar").alt=e.offer.description,n.querySelector(".popup__title").textContent=e.offer.title,n.querySelector(".popup__text--address").textContent=e.offer.address,n.querySelector(".popup__text--price").textContent=e.offer.price+"₽/ночь",n.querySelector(".popup__type").textContent=t[e.offer.type].ru,n.querySelector(".popup__text--capacity").textContent=`${e.offer.rooms} ${1===e.offer.rooms?"комната":"комнаты"} для ${e.offer.guests} ${1===e.offer.guests?"гостя":"гостей"}`,n.querySelector(".popup__text--time").textContent=`Заезд после ${e.offer.checkin}, выезд до ${e.offer.checkout}`;let i=n.querySelectorAll(".popup__feature");for(let t of i)e.offer.features.indexOf(t.classList[1].replace("popup__feature--",""))<0&&t.remove();n.querySelector(".popup__description").textContent=e.offer.description;let c=n.querySelector(".popup__photos"),u=c.querySelector(".popup__photo");if(e.offer.photos.length>0){u.remove();for(let t of e.offer.photos){let e=document.querySelector("#card").content.querySelector(".popup__photo").cloneNode(!0);e.src=t,c.appendChild(e)}}else c.remove();let d=n.querySelector(".popup__close");return document.addEventListener("keydown",o),d.addEventListener("click",(function(){r(),window.pin.removeActivePin(),document.removeEventListener("keydown",o)})),n},removePopup:r}})(),(()=>{let e=window.constants.TYPES,t=window.main.adFormElement,n=t.querySelector("#type"),o=t.querySelector("#price"),r=t.querySelector("#room_number"),i=t.querySelector("#capacity"),c=t.querySelector("#timein"),u=t.querySelector("#timeout"),d=t.querySelector(".ad-form__reset"),a={1:[1],2:[1,2],3:[1,2,3],100:[0]};window.main.pinAddressInputElement.readOnly=!0,n.addEventListener("change",(function(){o.min=e[n.value].min,o.placeholder=e[n.value].min})),r.addEventListener("change",(function(){!function(e){let t=i.querySelectorAll("option");for(let e=0;e<t.length;e++)t[e].disabled=!0;a[e].forEach((function(e){i.querySelector(`[value="${e}"]`).disabled=!1,i.value=e}))}(r.value)})),c.addEventListener("change",(function(){u.value=c.value})),u.addEventListener("change",(function(){c.value=u.value}));let l=function(){window.message.onErrorSend("Ошибка загрузки объявления")},s=function(){window.message.onSuccessSend(),window.main.getDeactivePage()};t.addEventListener("submit",(function(e){e.preventDefault(),window.backend.save(s,l,new FormData(t))})),d.addEventListener("click",(function(e){e.preventDefault(),window.main.getDeactivePage()}))})(),(()=>{let e=window.main.mapFiltersContainer.querySelector("form"),t={low:{start:0,end:1e4},middle:{start:1e4,end:5e4},high:{start:5e4,end:1/0}},n=Array.from(e.children),o={"housing-type":function(e,t){return t.value===e.offer.type},"housing-price":function(e,n){return e.offer.price>=t[n.value].start&&e.offer.price<t[n.value].end},"housing-rooms":function(e,t){return t.value===e.offer.rooms.toString()},"housing-guests":function(e,t){return t.value===e.offer.guests.toString()},"housing-features":function(e,t){return Array.from(t.querySelectorAll("input[type=checkbox]:checked")).every((function(t){return e.offer.features.some((function(e){return e===t.value}))}))}},r=function(e){return e.filter((function(e){return n.every((function(t){return"any"===t.value||o[t.id](e,t)}))}))},i=window.debounce((function(){window.card.removePopup(),window.pin.removePins(),window.main.createPins(r(window.main.offers()).slice(0,window.main.MAX_COUNT))}));e.addEventListener("change",i),window.filter=r})(),(()=>{const e=["gif","jpg","jpeg","png"];let t=70,n=70,o="Фотография жилья",r=window.main.adFormElement,i=r.querySelector(".ad-form-header__upload input[type=file]"),c=r.querySelector(".ad-form-header__upload img"),u=c.src,d=r.querySelector(".ad-form__photo-container"),a=r.querySelector(".ad-form__upload input[type=file]"),l=r.querySelector(".ad-form__photo"),s=[],p=function(t,n){let o=t.files[0],r=o.name.toLowerCase();if(e.some((function(e){return r.endsWith(e)}))){let e=new FileReader;e.addEventListener("load",(function(){n(e.result)})),e.readAsDataURL(o)}};i.addEventListener("change",(function(){p(i,(function(e){c.src=e}))})),a.addEventListener("change",(function(){p(a,f)}));let f=function(e){let r=document.createElement("div");r.classList.add("ad-form__photo");let i=document.createElement("img");i.src=e,i.width=t,i.height=n,i.alt=o,r.appendChild(i),s.push(r),d.insertBefore(r,l)};window.preview={resetPreview:function(){s&&s.forEach((function(e){e.remove()})),s=[],c.src=u}}})(),(()=>{let e=window.main.mapPinMainElement,t=e.clientWidth,n=e.clientHeight,o=window.constants.MIN_LOCATION_X,r=window.constants.MIN_LOCATION_Y,i=window.constants.MAX_LOCATION_Y,c=window.constants.MAX_LOCATION_X;e.addEventListener("mousedown",(function(u){if(u.button===window.util.key.LEFT_MOUSE){u.preventDefault();let d={x:u.clientX,y:u.clientY},a=function(u){u.preventDefault();let a={x:d.x-u.clientX,y:d.y-u.clientY};d={x:u.clientX,y:u.clientY},function(u){let d=e.offsetTop-u.y,a=e.offsetLeft-u.x;a>c-t/2?a=c-t/2:a<o-t/2&&(a=o-t/2),d>i-n?d=i-n:d<r-n&&(d=r-n),e.style.top=d+"px",e.style.left=a+"px",window.main.pinAddressInputElement.value=Math.round(parseInt(e.style.left,10)+t/2)+", "+Math.round(parseInt(e.style.top,10)+n/2)}(a)},l=function(e){e.preventDefault(),document.removeEventListener("mousemove",a),document.removeEventListener("mouseup",l)};document.addEventListener("mousemove",a),document.addEventListener("mouseup",l)}}))})()})();