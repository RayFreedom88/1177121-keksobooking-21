(()=>{"use strict";(()=>{const e=document.querySelector(".map"),t=e.querySelector(".map__pin--main");window.mainElement={map:e,pin:t}})(),(()=>{let e={COORDS_X:570,COORDS_Y:375,GUESTS_COUNT:1,MAX_COUNT:5,MIN_WIDTH_PINS:50,MIN_HEIGHT_PINS:70,MIN_LOCATION_X:0,MAX_LOCATION_X:document.querySelector(".map").offsetWidth,MIN_LOCATION_Y:130,MAX_LOCATION_Y:630,NUMBER_GUEST:{1:[1],2:[1,2],3:[1,2,3],100:[0]},TYPES:{palace:{ru:"Дворец",min:"10000"},flat:{ru:"Квартира",min:"1000"},house:{ru:"Дом",min:"5000"},bungalow:{ru:"Бунгало ",min:"0"}}};window.constants=e})(),(()=>{let e={LEFT_MOUSE:0,ENTER:13,ESC:27};window.util={key:e,onEnterEvent:function(t,n){t.keyCode===e.ENTER&&n()},onEscEvent:function(t,n){t.keyCode===e.ESC&&(t.preventDefault(),n())}}})(),window.debounce=function(e){let t=null;return function(...n){t&&window.clearTimeout(t),t=window.setTimeout((function(){e(...n)}),500)}},(()=>{let e=!1,t=document.querySelector("main"),n=document.querySelector("#error").content.querySelector(".error"),o=document.querySelector("#success").content.querySelector(".success"),r=function(){u()},i=function(){u()},c=function(e){window.util.onEscEvent(e,u)},d=function(){document.addEventListener("keydown",c),document.addEventListener("mousedown",i)},u=function(){let t=e?".error":".success";document.querySelector(t).remove(),document.removeEventListener("keydown",c),document.removeEventListener("mousedown",i)};window.message={onErrorSend:function(o){e=!0;let i=n.cloneNode(!0);i.querySelector(".error__message").textContent=o,i.querySelector(".error__button").addEventListener("click",r),t.appendChild(i),d()},onSuccessSend:function(){e=!1;let n=o.cloneNode(!0);t.appendChild(n),d()}}})(),(()=>{let e=function(e,t,n){let o=new XMLHttpRequest;o.responseType="json",o.timeout=1e4,o.addEventListener("load",(function(){200===o.status?e(o.response):t("Cтатус ответа: "+o.status+" "+o.statusText)})),o.addEventListener("error",(function(){t("Произошла ошибка соединения")})),o.addEventListener("timeout",(function(){t("Запрос не успел выполниться за "+o.timeout+"мс")})),n?(o.open("POST","https://21.javascript.pages.academy/keksobooking"),o.send(n)):(o.open("GET","https://21.javascript.pages.academy/keksobooking/data"),o.send())};window.backend={load:e,save:e}})(),(()=>{const e=window.mainElement.map.querySelector(".map__filters-container"),t=e.querySelector("form");let n={low:{start:0,end:1e4},middle:{start:1e4,end:5e4},high:{start:5e4,end:1/0}},o=Array.from(t.children),r={"housing-type":function(e,t){return t.value===e.offer.type},"housing-price":function(e,t){return e.offer.price>=n[t.value].start&&e.offer.price<n[t.value].end},"housing-rooms":function(e,t){return t.value===e.offer.rooms.toString()},"housing-guests":function(e,t){return t.value===e.offer.guests.toString()},"housing-features":function(e,t){return Array.from(t.querySelectorAll("input[type=checkbox]:checked")).every((function(t){return e.offer.features.some((function(e){return e===t.value}))}))}},i=function(e){return e.filter((function(e){return o.every((function(t){return"any"===t.value||r[t.id](e,t)}))}))},c=window.debounce((function(){window.card.remove(),window.pin.remove(),window.pin.render(i(window.main.offers()).slice(0,window.constants.MAX_COUNT))}));t.addEventListener("change",c),window.filter={element:{container:e,form:t},filterData:i}})(),(()=>{let e=window.constants.TYPES;const t=document.querySelector(".ad-form"),n=t.querySelectorAll("fieldset"),o=t.querySelector("#address");let r=t.querySelector("#type"),i=t.querySelector("#price"),c=t.querySelector("#room_number"),d=t.querySelector("#capacity"),u=t.querySelector("#timein"),a=t.querySelector("#timeout"),l=t.querySelector(".ad-form__reset"),s=window.constants.NUMBER_GUEST;const f=window.filter.element.form.querySelectorAll(".map__filter");o.readOnly=!0;let p=function(e){for(let t=0;t<e.length;t++)e[t].disabled=!0},m=function(e){for(let t=0;t<e.length;t++)e[t].disabled=!1},w=function(){i.min=e[r.value].min,i.placeholder=e[r.value].min};r.addEventListener("change",w),c.addEventListener("change",(function(){!function(e){let t=d.querySelectorAll("option");for(let e=0;e<t.length;e++)t[e].disabled=!0;s[e].forEach((function(e){d.querySelector(`[value="${e}"]`).disabled=!1,d.value=e}))}(c.value)})),u.addEventListener("change",(function(){a.value=u.value})),a.addEventListener("change",(function(){u.value=a.value}));let v=function(){window.message.onErrorSend("Ошибка загрузки объявления")},_=function(){window.message.onSuccessSend(),window.main.deactivatePage()};t.addEventListener("submit",(function(e){e.preventDefault(),window.backend.save(_,v,new FormData(t))})),l.addEventListener("click",(function(e){e.preventDefault(),window.main.deactivatePage()})),window.form={element:{ad:t,pinAddressInput:o},setAddressCoords:function(e,t){o.value=e+","+t},setDisabled:function(){p(n),p(f)},setActive:function(){m(n),m(f)},onTypeSelectChange:w}})(),(()=>{const e=window.constants.MIN_WIDTH_PINS,t=window.constants.MIN_HEIGHT_PINS;let n=window.mainElement.map,o=n.querySelector(".map__pins"),r=window.filter.element.container,i=document.querySelector("#pin").content,c=function(c){let u=i.querySelector(".map__pin").cloneNode(!0);u.querySelector("img").src=c.author.avatar,u.querySelector("img").alt=c.offer.description;let a=c.location.x-e/2+"px",l=c.location.y-t+"px";return u.style.left=a,u.style.top=l,o.appendChild(u),u.addEventListener("click",(function(){d(),u.classList.add("map__pin--active"),window.card.remove(),n.insertBefore(window.card.create(c),r)})),u},d=function(){let e=n.querySelector(".map__pin--active");null!==e&&e.classList.remove("map__pin--active")};window.pin={create:c,render:function(e){let t=document.createDocumentFragment();e.forEach((function(e){t.appendChild(c(e))})),o.appendChild(t)},remove:function(){let e=n.querySelectorAll(".map__pin:not(.map__pin--main)");e.length>0&&e.forEach((function(e){e.remove()}))},removeActive:d}})(),(()=>{let e=window.util.onEscEvent,t=window.constants.TYPES,n=window.mainElement.map,o=document.querySelector("#card").content,r=function(t){let o=n.querySelector(".popup");e(t,(function(){null!==o&&(i(),document.removeEventListener("keydown",r),window.pin.removeActive())}))},i=function(){let e=n.querySelector(".popup");null!==e&&e.remove()};window.card={create:function(e){let n=o.querySelector(".map__card").cloneNode(!0);n.querySelector(".popup__avatar").src=e.author.avatar,n.querySelector(".popup__avatar").alt=e.offer.description,n.querySelector(".popup__title").textContent=e.offer.title,n.querySelector(".popup__text--address").textContent=e.offer.address,n.querySelector(".popup__text--price").textContent=e.offer.price+"₽/ночь",n.querySelector(".popup__type").textContent=t[e.offer.type].ru,n.querySelector(".popup__text--capacity").textContent=`${e.offer.rooms} ${e.offer.rooms===window.constants.GUESTS_COUNT?"комната":"комнаты"} для ${e.offer.guests} ${e.offer.guests===window.constants.GUESTS_COUNT?"гостя":"гостей"}`,n.querySelector(".popup__text--time").textContent=`Заезд после ${e.offer.checkin}, выезд до ${e.offer.checkout}`;let c=n.querySelector(".popup__features"),d=n.querySelectorAll(".popup__feature");for(let t of d)e.offer.features.indexOf(t.classList[1].replace("popup__feature--",""))<0&&t.remove(),0===e.offer.features.length&&c.remove();n.querySelector(".popup__description").textContent=e.offer.description;let u=n.querySelector(".popup__photos"),a=u.querySelector(".popup__photo");if(e.offer.photos.length>0){a.remove();for(let t of e.offer.photos){let e=document.querySelector("#card").content.querySelector(".popup__photo").cloneNode(!0);e.src=t,u.appendChild(e)}}else u.remove();let l=n.querySelector(".popup__close");return document.addEventListener("keydown",r),l.addEventListener("click",(function(){i(),window.pin.removeActive(),document.removeEventListener("keydown",r)})),n},remove:i}})(),(()=>{const e=["gif","jpg","jpeg","png"];let t=70,n=70,o="Фотография жилья",r=window.form.element.ad,i=r.querySelector(".ad-form-header__upload input[type=file]"),c=r.querySelector(".ad-form-header__upload img"),d=c.src,u=r.querySelector(".ad-form__photo-container"),a=r.querySelector(".ad-form__upload input[type=file]"),l=r.querySelector(".ad-form__photo"),s=[],f=function(t,n){let o=t.files[0],r=o.name.toLowerCase();if(e.some((function(e){return r.endsWith(e)}))){let e=new FileReader;e.addEventListener("load",(function(){n(e.result)})),e.readAsDataURL(o)}};i.addEventListener("change",(function(){f(i,(function(e){c.src=e}))})),a.addEventListener("change",(function(){f(a,p)}));let p=function(e){let r=document.createElement("div");r.classList.add("ad-form__photo");let i=document.createElement("img");i.src=e,i.width=t,i.height=n,i.alt=o,r.appendChild(i),s.push(r),u.insertBefore(r,l)};window.preview={reset:function(){s&&s.forEach((function(e){e.remove()})),s=[],c.src=d}}})(),(()=>{let e=window.mainElement.pin,t=e.clientWidth,n=e.clientHeight,o=window.constants.MIN_LOCATION_X,r=window.constants.MIN_LOCATION_Y,i=window.constants.MAX_LOCATION_Y,c=window.constants.MAX_LOCATION_X;e.addEventListener("mousedown",(function(d){if(d.button===window.util.key.LEFT_MOUSE){d.preventDefault();let u={x:d.clientX,y:d.clientY},a=function(d){d.preventDefault();let a={x:u.x-d.clientX,y:u.y-d.clientY};u={x:d.clientX,y:d.clientY},function(d){let u=e.offsetTop-d.y,a=e.offsetLeft-d.x;a>c-t/2?a=c-t/2:a<o-t/2&&(a=o-t/2),u>i-n?u=i-n:u<r-n&&(u=r-n),e.style.top=u+"px",e.style.left=a+"px",window.form.element.pinAddressInput.value=Math.round(parseInt(e.style.left,10)+t/2)+", "+Math.round(parseInt(e.style.top,10)+n/2)}(a)},l=function(e){e.preventDefault(),document.removeEventListener("mousemove",a),document.removeEventListener("mouseup",l)};document.addEventListener("mousemove",a),document.addEventListener("mouseup",l)}}))})(),(()=>{const e=window.constants.MAX_COUNT,t=window.constants.COORDS_X,n=window.constants.COORDS_Y,o=window.mainElement.map,r=window.mainElement.pin,i=window.filter.element.form,c=window.form.element.ad;let d=[];window.form.setAddressCoords(t,n),window.form.setDisabled();let u=function(t){d=t.slice().filter((function(e){return 0!==Object.keys(e.offer).length})),window.pin.render(d.slice(0,e)),window.form.setActive(),o.classList.remove("map--faded"),c.classList.remove("ad-form--disabled"),r.removeEventListener("mousedown",s),r.removeEventListener("keydown",f)},a=function(e){window.message.onErrorSend(e)},l=function(){window.backend.load(u,a)},s=function(e){e.button===window.util.key.LEFT_MOUSE&&l()},f=function(e){window.util.onEnterEvent(e,(function(){l()}))};r.addEventListener("mousedown",s),r.addEventListener("keydown",f),window.main={offers:()=>d,deactivatePage:function(){o.classList.add("map--faded"),i.reset(),c.reset(),c.classList.add("ad-form--disabled"),window.form.onTypeSelectChange(),window.form.setDisabled(),window.form.setAddressCoords(t,n),r.style.left=t+"px",r.style.top=n+"px",window.card.remove(),window.pin.remove(),window.preview.reset(),r.addEventListener("mousedown",s),r.addEventListener("keydown",f)}}})()})();